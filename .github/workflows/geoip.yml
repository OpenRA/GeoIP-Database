name: GeoIP

on:
  schedule:
    - cron: '28 13 7 * *'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.latest_release_info.outputs.id }}
      upload_url: ${{ steps.latest_release_info.outputs.upload_url }}
    steps:
      - name: Gets latest created release info
        id: latest_release_info
        uses: jossef/action-latest-release-info@v1.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GEOIP_TOKEN }}

  download:
    name: Cache GeoIP database
    runs-on: ubuntu-latest
    needs: release
    steps:
     - name: Clone repository
       uses: actions/checkout@v2

     - name: Fetch GeoIP from ip2location.
       run: ./fetch-geoip.sh

     - name: Delete old release assets
       uses: flcdrg/remove-release-asset-action@v1.0.12
       id: remove
       env:
            GITHUB_TOKEN: ${{ secrets.GEOIP_TOKEN }}
       with:
            release_id: ${{ needs.release.outputs.id }}
            asset_name: IP2LOCATION-LITE-DB1.IPV6.BIN.1.ZIP

     - name: Upload release asset
       id: upload-release-asset
       uses: actions/upload-release-asset@v1
       env:
         GITHUB_TOKEN: ${{ secrets.GEOIP_TOKEN }}
       with:
          upload_url: https://github.com/OpenRA/GeoIP-Database/releases/download/49852973/assets?name=IP2LOCATION-LITE-DB1.IPV6.BIN.1.ZIP
          asset_path: ./IP2LOCATION-LITE-DB1.IPV6.BIN.ZIP
          asset_name: IP2LOCATION-LITE-DB1.IPV6.BIN.ZIP
          asset_content_type: application/zip
